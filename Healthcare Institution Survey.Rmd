---
title: "Healthcare Institution Survey"
output: html_document
date: "2025-08-19"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Install Packages

```{r}
#install.packages("dplyr")
#install.packages("knitr")
#install.packages("tibble")
#install.packages("ggplot2")
#install.packages("readxl")
#install.packages("flextable")
#install.packages("officer")
#install.packages("RColorBrewer")
#install.packages("stringr")
```

## Import libraries

```{r}
library(dplyr)
library(knitr)
library(tibble)
library(ggplot2)
library(tidyr)
library(flextable)
library(readxl)
library(officer)
library(RColorBrewer)
library(stringr)
```    


## Read datasets and make a copy

```{r}
setwd("/Users/lesliebernhardt/Library/CloudStorage/OneDrive-gematik.de/Masterarbeit/Datens√§tze")
lei1 <- readxl::read_excel("LEI_QER4.xlsx", col_names = TRUE)
lei <- lei1

# Missing data
lei[lei == 8888888] <- NA
lei[lei == 9999999] <- NA
```

## Awareness ePA

```{r}
farben <- c(
  "ePA known" = "#4ca96b",
  "ePA not known" = "#ff6f61",
  "No response" = "#bdbdbd"
)

# Filter data
lei_filtered <- lei[lei$lei0_1 == 1 & lei$lei11_1_1 == 1,]

sum(lei$lei0_1 == 1 & lei$lei11_1_1 == 1, na.rm = TRUE)

anzahl_ja <- sum(lei_filtered$lei2_1_4 == 1, na.rm = TRUE)
anzahl_nein <- sum(lei_filtered$lei2_1_4 == 0, na.rm = TRUE) +
                 sum(lei_filtered$lei2_1_12 == 1, na.rm = TRUE)
no_response <- sum(lei_filtered$lei2_1_13 == 1, na.rm = TRUE)
print(no_response)


anzahl_gesamt <- (anzahl_ja + anzahl_nein + no_response)
print(anzahl_gesamt)

print(anzahl_na)
print(anzahl_ja)
print(anzahl_nein)


prozent_ja <- (anzahl_ja / anzahl_gesamt) * 100
prozent_nein <- (anzahl_nein / anzahl_gesamt) * 100
prozenz_no_response <- (no_response / anzahl_gesamt) * 100


data <- data.frame(
  Category = c("ePA known", "ePA not known", "No response"),
  Count = c(anzahl_ja, anzahl_nein, no_response)
)
data$Percentage <- round((data$Count / sum(data$Count)) * 100,2)
data$Label <- paste(data$Percentage, "%", sep = "")

# Create plot
ggplot(data, aes(x = "", y = Count, fill = Category)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +
  theme_void() +
  theme(
    plot.title = element_text(size = 18, hjust = 0.5, face = "bold"),
    legend.text = element_text(size = 16),
    legend.title = element_blank()
  ) +
  labs(title = "Distribution of ePA Awareness") +
  scale_fill_manual(values = farben) +
  geom_text(aes(label = Label), position = position_stack(vjust = 0.5), size = 6)



```

## Concerns of Implementation

```{r}
# Filter the dataset for individuals who selected "1" for lei0_1
lei_filtered <- lei[lei$lei0_1 == 1 & lei$lei11_1_1 == 1, ]

relevant_columns <- c(
  "lei2_4_1", "lei2_4_2", "lei2_4_3", "lei2_4_5",
  "lei2_4_6", "lei2_4_7", "lei2_4_8", "lei2_4_9", "lei2_4_10",
  "lei2_4_11", "lei2_4_14", "lei2_4_15"
)
total_responses <- nrow(lei_filtered)

# Count how many respondents selected "1" for each of the relevant answers and calculate percentages
aggregated_data <- lei_filtered %>%
  select(all_of(relevant_columns)) %>% 
  summarise_all(~ sum(. == 1, na.rm = TRUE)) %>%  
  pivot_longer(cols = everything(), names_to = "Concerns", values_to = "Count") %>%  
  mutate(Percentage = (Count / total_responses) * 100)  

label_mapping <- data.frame(
  Concerns = relevant_columns,
  Labels = c(
    "Currently no concerns [exclusive]",
    "Primary system not sufficiently tested",
    "Effort due to changing workflows",
    "Practical effort in usage",
    "Data synchronization between primary system\nand ePA insufficiently automated",
    "Unclear access rights\n(who can write, read, delete?)",
    "Lack of access permissions by patients",
    "Mandatory viewing/updating of documents", 
    "Problems finding information\nin the uploaded documents",
    "Unclear naming of documents",
    "Uncontrolled display of external findings",
    "Issues related to billing"
  )
)

# Replace technical names with descriptive labels
aggregated_data <- aggregated_data %>%
  left_join(label_mapping, by = "Concerns") %>%
  mutate(Concerns = Labels) %>%  
  select(-Labels)  

# Remove rows with NA or 0 counts
aggregated_data <- aggregated_data %>%
  filter(!is.na(Count) & Count > 0)

# Sort aggregated data by Percentage in descending order
aggregated_data <- aggregated_data %>%
  arrange(desc(Percentage))  

# Choose colors
color_palette <- colorRampPalette(c("#08306B", "#6BAED6", "#C6DBEF"))(nrow(aggregated_data))  
aggregated_data$Color <- color_palette  

# Create plot
plot <- ggplot(aggregated_data, aes(x = reorder(Concerns, Percentage), y = Percentage, fill = Color)) +
  geom_bar(stat = "identity", na.rm = TRUE, width = 0.8) +  
  geom_text(
    aes(label = paste0(round(Percentage), "%")), 
    hjust = -0.2,        
    size = 4             
  ) +
  coord_flip() +  
  labs(title = "Concerns of Implementation", 
       y = "Percentage", 
       x = NULL) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold"),  
    axis.title = element_text(size = 12),  
    axis.text = element_text(size = 12, face = "bold"),  
    axis.text.y = element_text(size = 12),  
    legend.position = "none"  
  ) +
  scale_fill_identity() +  
  scale_y_continuous(limits = c(0, 100), expand = c(0, 5))  

print(plot)


```


## Distribution of ePA Usage

```{r}
# Choose colors
blue_palette <- c(
  "Not installed" = "#ff6f61",
  "Installed but not used" = "#ff9e81",
  "Rarely used or tested" = "#66c2a4",
  "Regularly used" = "#4ca96b",
  "No response" = "#bdbdbd"
)

# Filter data
lei_filtered <- lei %>%
  filter(lei0_1 == 1 & lei1_1 == 1 & lei2_1_4 == 1 & lei$lei11_1_1 == 1, )

# Add a new grouping: General Practitioner or Specialist
lei_filtered$group <- ifelse(lei_filtered$lei0_2 %in% c(2, 3, 4), "General Practitioner", "Specialist")

# Add a new grouping: Practice Structure (Solo Practice, Group Practice, MCC)
lei_filtered$practice_structure <- ifelse(
  lei_filtered$lei0_5 == 1, "Solo Practice",
  ifelse(lei_filtered$lei0_5 %in% c(2, 3, 4), "Group Practice",
  ifelse(lei_filtered$lei0_5 %in% c(5, 6), "MCC", NA))
)

# Check if the filtered dataset contains any entries
anzahl <- nrow(lei_filtered)
if (anzahl == 0) {
  stop("The filtered dataset contains no entries. Please check the filter conditions.")
}
print(paste("Number of elements:", anzahl))

# Mapping: Descriptive labels for the original groups
label_mapping <- data.frame(
  lei0_7 = c(1, 2, 3),
  Group = c(
    "1 Physician",
    "2 to 4 Physicians",
    "5 or more Physicians"
  )
)

# Apply conditions and calculate the distribution
response_distribution <- lei_filtered %>%
  mutate(
    Group = case_when(
      lei0_7 == 3 ~ "5 or more Physicians",
      lei0_7 == 2 ~ "2 to 4 Physicians",
      lei0_7 == 1 ~ "1 Physician",
      TRUE ~ NA_character_  # Fallback for other values
    ),
    Response = case_when(
      lei3_1_3 == 1 ~ "Not installed",
      lei3_1_3 == 2 ~ "Installed but not used",
      lei3_1_3 == 3 ~ "Rarely used or tested",
      lei3_1_3 == 4 ~ "Regularly used",
      TRUE ~ "No response"  # Default for NA or other values
    )
  ) %>%
  filter(!is.na(Group) & !is.na(Response)) %>%  # Remove invalid values
  group_by(Group, Response) %>%
  summarise(Count = n(), .groups = "drop") %>%
  group_by(Group) %>%
  mutate(Percentage = round((Count / sum(Count)) * 100))  # Round to whole numbers

# Add the "General Practitioner" and "Specialist" groups
additional_distribution <- lei_filtered %>%
  mutate(
    Group = group,  # Use the new grouping
    Response = case_when(
      lei3_1_3 == 1 ~ "Not installed",
      lei3_1_3 == 2 ~ "Installed but not used",
      lei3_1_3 == 3 ~ "Rarely used or tested",
      lei3_1_3 == 4 ~ "Regularly used",
      TRUE ~ "No response"  # Default for NA or other values
    )
  ) %>%
  filter(!is.na(Group) & !is.na(Response)) %>%  # Remove invalid values
  group_by(Group, Response) %>%
  summarise(Count = n(), .groups = "drop") %>%
  group_by(Group) %>%
  mutate(Percentage = round((Count / sum(Count)) * 100))  # Round to whole numbers

# Add the "Practice Structure" groups
practice_structure_distribution <- lei_filtered %>%
  mutate(
    Group = practice_structure,  # Use the practice structure grouping
    Response = case_when(
      lei3_1_3 == 1 ~ "Not installed",
      lei3_1_3 == 2 ~ "Installed but not used",
      lei3_1_3 == 3 ~ "Rarely used or tested",
      lei3_1_3 == 4 ~ "Regularly used",
      TRUE ~ "No response"  # Default for NA or other values
    )
  ) %>%
  filter(!is.na(Group) & !is.na(Response)) %>%  
  group_by(Group, Response) %>%
  summarise(Count = n(), .groups = "drop") %>%
  group_by(Group) %>%
  mutate(Percentage = round((Count / sum(Count)) * 100))  

response_distribution <- bind_rows(response_distribution, additional_distribution, practice_structure_distribution)

response_distribution <- response_distribution %>%
  group_by(Group) %>%
  mutate(
    Percent_raw = (Count / sum(Count)) * 100,
    Percentage = if_else(
      row_number() == n(),
      100 - sum(round(Percent_raw)[1:(n()-1)]),
      round(Percent_raw)
    )
  ) %>%
  ungroup()

response_distribution$Response <- factor(
  response_distribution$Response,
  levels = c("Regularly used", "Rarely used or tested", "Installed but not used", "Not installed", "No response")
)

# Set the order of groups
response_distribution$Group <- factor(
  response_distribution$Group,
  levels = c("1 Physician", "2 to 4 Physicians", "5 or more Physicians", "General Practitioner", "Specialist", "Solo Practice", "Group Practice", "MCC")
)

# Wrap long labels for better readability
response_distribution$Group <- str_wrap(response_distribution$Group, width = 20)

# Create plot
plot <- ggplot(response_distribution, aes(y = Group, x = Percentage / 100, fill = Response)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  geom_text(
    aes(label = ifelse(Percentage > 0, paste0(Percentage, "%"), "")), 
    position = position_stack(vjust = 0.5),
    size = 6, color = "black"
  ) +
  labs(
    title = "Distribution of ePA Usage",
    x = "Percentage",
    y = NULL,
    fill = "Response Category"
  ) +
  scale_fill_manual(values = blue_palette) +
  scale_x_continuous(
    breaks = seq(0, 1, by = 0.25),
    labels = scales::percent_format(accuracy = 1)
  ) +
  scale_y_discrete(limits = c(
    "General Practitioner", 
    "Specialist", 
    "1 Physician",
    "2 to 4 Physicians", 
    "5 or more Physicians",
    "Solo Practice", 
    "Group Practice", 
    "MCC"
  )) +  
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
    axis.title.x = element_text(size = 18),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 16),
    legend.position = "right",
    plot.margin = margin(10, 10, 10, 10)
  )
print(plot)

```

## Distribution of Statements on ePA

```{r}

# Filtered dataset
lei_filtered <- lei[lei$lei0_1 == 1 &  lei3_1_3 == 4 & lei$lei1_1 == 1, ]
anzahl <- length(lei_filtered)
print(paste("Anzahl der Elemente:", anzahl))

relevant_columns <- c(
  "lei6_3_1", "lei6_3_2", "lei6_3_3", 
  "lei6_3_4", "lei6_3_5", "lei6_3_6"
)

# Mapping descriptive labels for the questions
label_mapping <- data.frame(
  Statement = relevant_columns,
  Labels = c(
    "It is easy to find and open an existing ePA.",
    "The document exchange with my patients runs smoothly.",
    "The ePA enables quick technical access to required patient data.",
    "Relevant information can be quickly found in the ePA.",
    "The ePA saves time in patient care.",
    "The ePA will improve medical care."
  )
)

response_distribution <- lei_filtered %>%
  select(all_of(relevant_columns)) %>%
  pivot_longer(cols = everything(), names_to = "Statement", values_to = "Response") %>%
  filter(!is.na(Response)) %>%
  group_by(Statement, Response) %>%
  summarise(Count = n(), .groups = "drop") %>%
  group_by(Statement) %>%
  mutate(
    PercentRaw = (Count / sum(Count)) * 100,
    Percentage = if_else(
      row_number() == n(),
      100 - sum(round(PercentRaw)[1:(n()-1)]),
      round(PercentRaw)
    )
  ) %>%
  left_join(label_mapping, by = "Statement") %>%
  mutate(Statement = Labels)  # Replace statement codes with full labels


response_labels <- c(
  "Fully agree", "Rather agree", "Rather disagree", "Strongly disagree", "Situation has not\nocurred so far", "Don't know/No answer"
)

# Colour palette
likert_palette <- c(
  "Fully agree" = "#4ca96b",          
  "Rather agree" = "#66c2a4",         
  "Rather disagree" = "#ff9e81",            
  "Strongly disagree" = "#ff6f61",
  "Situation has not\nocurred so far" = "#bdbdbd", 
  "Don't know/No answer" = "#f0f0f0" 
)

# Convert Response to factor with labels
response_distribution$Response <- factor(
  response_distribution$Response, 
  levels = 1:6, 
  labels = response_labels
)

# Apply line breaks to long statements
response_distribution$Statement <- str_wrap(response_distribution$Statement, width = 20)

# Create plot
ggplot(response_distribution, aes(y = Statement, x = Percentage / 100, fill = Response)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  geom_text(
    aes(label = ifelse(Percentage > 0, paste0(Percentage, "%"), "")),
    position = position_stack(vjust = 0.5),
    size = 7, color = "black"  
  ) +
  labs(
    title = "Distribution of Responses to ePA Statements",
    x = "Percentage",
    y = NULL,
    fill = NULL
  ) +
  scale_fill_manual(values = likert_palette) +
  scale_x_continuous(
    breaks = seq(0, 1, by = 0.25),
    labels = scales::percent_format(accuracy = 1)
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 26, hjust = 0.5),
    axis.title.x = element_text(size = 18),
    axis.text.x = element_text(size = 18),
    axis.text.y = element_text(size = 18, face = "bold"),
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 18),
    legend.position = "right",
    plot.margin = margin(10, 10, 10, 10)
  )
```

 
 